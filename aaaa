var __defProp = Object.defineProperty;
var __name = (target, value) => __defProp(target, "name", { value, configurable: true });

function createIsolatedInstance(instanceId) {
  console.log(`ğŸ†• [${instanceId}] %100 TAM Ä°ZOLE INSTANCE OLUÅTURULUYOR`);
  
  // âœ… 1. INSTANCE'A Ã–ZEL CONSTANT'LAR
  const INSTANCE_CONSTANTS = {
    COOKIE_API_URL: "https://burnrndr.onrender.com/last-cookies",
    DEBUG_MODE: true
  };

  // âœ… 2. INSTANCE'A Ã–ZEL HELPER FONKSÄ°YONLAR
  function hashString(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      const char = str.charCodeAt(i);
      hash = (hash << 5) - hash + char;
      hash = hash & hash;
    }
    return Math.abs(hash);
  }
  __name(hashString, "hashString");

  function debugLog(...args) {
    if (INSTANCE_CONSTANTS.DEBUG_MODE) console.log(`[${instanceId}]`, ...args);
  }
  __name(debugLog, "debugLog");

  function errorLog(...args) {
    console.log(`[${instanceId}]`, ...args);
  }
  __name(errorLog, "errorLog");

  // âœ… 3. TAM COOKIE MANAGER Ä°ZOLASYONU
  function createIsolatedCookieManager() {
    debugLog(`ğŸª YENÄ° COOKIE MANAGER OLUÅTURULUYOR - TAM Ä°ZOLE`);
    
    const cookieManager = {
      cachedCookieSets: {},
      lastFetchTime: 0,
      instanceCounter: 0,
      isRefreshing: false,
      refreshPromise: null,
      
      async getCookieSetForInstance() {
        if (Object.keys(this.cachedCookieSets).length === 0 || Date.now() - this.lastFetchTime > 300000) {
          await this.refreshCookiesWithLock();
        }
        const setKeys = Object.keys(this.cachedCookieSets);
        if (setKeys.length === 0) {
          throw new Error("Cookie set bulunamadÄ±");
        }
        this.instanceCounter = (this.instanceCounter + 1) % setKeys.length;
        const selectedSetKey = setKeys[this.instanceCounter];
        const selectedSet = this.cachedCookieSets[selectedSetKey];
        debugLog(`ğŸ² Cookie Set: ${selectedSetKey}, SÄ±ra: ${this.instanceCounter}, Adet: ${selectedSet.length}`);
        return JSON.parse(JSON.stringify(selectedSet));
      },

      async refreshCookiesWithLock() {
        if (this.isRefreshing) {
          debugLog(`ğŸ”’ Cookie refresh bekleniyor...`);
          await this.refreshPromise;
          return;
        }
        this.isRefreshing = true;
        this.refreshPromise = this._doRefresh();
        try {
          await this.refreshPromise;
        } finally {
          this.isRefreshing = false;
          this.refreshPromise = null;
        }
      },

      async _doRefresh() {
        debugLog(`ğŸ”„ Cookie setleri yenileniyor...`);
        try {
          const response = await fetch(INSTANCE_CONSTANTS.COOKIE_API_URL);
          const data = await response.json();
          this.cachedCookieSets = {};
          Object.keys(data).forEach((key) => {
            if (key.startsWith("set") && Array.isArray(data[key])) {
              this.cachedCookieSets[key] = data[key];
            }
          });
          this.lastFetchTime = Date.now();
          const totalSets = Object.keys(this.cachedCookieSets).length;
          const totalCookies = Object.values(this.cachedCookieSets).reduce((sum, set) => sum + set.length, 0);
          debugLog(`âœ… ${totalSets} set yÃ¼klendi (toplam ${totalCookies} cookie)`);
        } catch (error) {
          debugLog(`âŒ Cookie alÄ±namadÄ±:`, error.message);
          throw error;
        }
      },

      getStatus() {
        const setKeys = Object.keys(this.cachedCookieSets);
        return {
          instanceId: instanceId,
          totalSets: setKeys.length,
          lastFetchTime: this.lastFetchTime,
          timeSinceLastFetch: this.lastFetchTime ? Date.now() - this.lastFetchTime : null,
          allSets: setKeys.reduce((acc, key) => {
            acc[key] = this.cachedCookieSets[key].length;
            return acc;
          }, {})
        };
      }
    };
    
    return cookieManager;
  }
  __name(createIsolatedCookieManager, "createIsolatedCookieManager");

  // âœ… 4. TAM TASK MANAGER Ä°ZOLASYONU
  function createIsolatedTaskManager() {
    debugLog(`ğŸ“ YENÄ° TASK MANAGER OLUÅTURULUYOR - TAM Ä°ZOLE`);
    
    const taskManager = {
      tasks: new Map(),
      maxTasks: 50,
      
      addTask(email) {
        const taskId = `task_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`;
        const task = {
          id: taskId,
          email,
          status: "processing",
          startTime: new Date().toISOString(),
          endTime: null,
          result: null,
          error: null,
          instanceData: null,
          instanceTrace: {
            instanceId,
            referenceId: null,
            requestId: null,
            email
          }
        };
        this.tasks.set(taskId, task);
        if (this.tasks.size > this.maxTasks) {
          const oldestKey = this.tasks.keys().next().value;
          this.tasks.delete(oldestKey);
        }
        debugLog(`ğŸ“ Yeni task: ${email}, Task: ${taskId}`);
        return task;
      },

      updateTask(taskId, updates) {
        const task = this.tasks.get(taskId);
        if (task) {
          Object.assign(task, updates);
          if (updates.instanceData) {
            task.instanceTrace.referenceId = updates.instanceData.referenceId;
            task.instanceTrace.requestId = updates.instanceData.requestId;
            task.instanceTrace.email = updates.instanceData.email;
          }
          debugLog(`ğŸ”„ Task gÃ¼ncellendi: ${updates.status}, Task: ${taskId}`);
        }
      },

      getRecentTasks() {
        return Array.from(this.tasks.values()).sort((a, b) => new Date(b.startTime) - new Date(a.startTime)).slice(0, this.maxTasks);
      },

      getStats() {
        const tasks = this.getRecentTasks();
        return {
          instanceId: instanceId,
          total: tasks.length,
          processing: tasks.filter((t) => t.status === "processing").length,
          completed: tasks.filter((t) => t.status === "completed").length,
          failed: tasks.filter((t) => t.status === "failed").length,
          error: tasks.filter((t) => t.status === "error").length,
          tasks
        };
      }
    };
    
    return taskManager;
  }
  __name(createIsolatedTaskManager, "createIsolatedTaskManager");

  // âœ… 5. DÄ°NAMÄ°K HEADER SET ÃœRETÄ°CÄ°
  function generateHeaderSets() {
    debugLog(`ğŸ­ DÄ°NAMÄ°K HEADER SETLERÄ° OLUÅTURULUYOR`);
    
    const platforms = ["Windows", "macOS", "Linux", "Android", "iOS"];
    const chromeVersions = ["120.0.0.0", "119.0.0.0", "121.0.0.0", "118.0.0.0"];
    const firefoxVersions = ["121.0", "120.0", "122.0", "119.0"];
    const safariVersions = ["17.1", "17.0", "16.6", "16.1"];
    
    const baseSeed = instanceId + Date.now();
    
    const INSTANCE_HEADER_SETS = [
      {
        "UserAgent": `Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/${chromeVersions[hashString(baseSeed + "1") % chromeVersions.length]} Safari/537.36`,
        "SecCHUA": `"Chromium";v="120", "Google Chrome";v="120", "Not-A.Brand";v="8"`,
        "SecCHUAMobile": "?0",
        "SecCHUAPlatform": '"Windows"',
        "Accept": "application/json, text/plain, */*",
        "AcceptLanguage": "tr-TR,tr;q=0.9,en-US;q=0.8,en;q=0.7",
        "AcceptEncoding": "gzip, deflate, br",
        "CacheControl": "no-cache",
        "Connection": "keep-alive"
      },
      {
        "UserAgent": `Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:${firefoxVersions[hashString(baseSeed + "2") % firefoxVersions.length]}) Gecko/20100101 Firefox/${firefoxVersions[hashString(baseSeed + "2") % firefoxVersions.length]}`,
        "Accept": "application/json, text/plain, */*",
        "AcceptLanguage": "tr-TR,tr;q=0.8,en-US;q=0.5,en;q=0.3",
        "AcceptEncoding": "gzip, deflate, br",
        "CacheControl": "no-cache",
        "Connection": "keep-alive"
      },
      {
        "UserAgent": `Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/${chromeVersions[hashString(baseSeed + "3") % chromeVersions.length]} Safari/537.36`,
        "SecCHUA": `"Chromium";v="120", "Google Chrome";v="120", "Not-A.Brand";v="8"`,
        "SecCHUAMobile": "?0",
        "SecCHUAPlatform": '"macOS"',
        "Accept": "application/json, text/plain, */*",
        "AcceptLanguage": "en-US,en;q=0.9,tr;q=0.8",
        "AcceptEncoding": "gzip, deflate, br",
        "CacheControl": "no-cache",
        "Connection": "keep-alive"
      }
    ];
    
    debugLog(`âœ… ${INSTANCE_HEADER_SETS.length} dinamik header set oluÅŸturuldu`);
    return INSTANCE_HEADER_SETS;
  }
  __name(generateHeaderSets, "generateHeaderSets");

  // âœ… 6. DÄ°NAMÄ°K EMAIL TEMPLATE ÃœRETÄ°CÄ° - BOZULMADAN
  function generateEmailTemplates() {
    debugLog(`ğŸ“§ DÄ°NAMÄ°K EMAIL TEMPLATE'LERÄ° OLUÅTURULUYOR`);
    
    const baseTemplates = [
      "jihpngpnd@emlhub.com", "tmrzfanje@emlpro.com", "wiraypzse@emlpro.com",
      "lnmwhbvvf@emltmp.com", "bshuzcvvf@emltmp.com", "hsfsqxcug@emltmp.com",
      "nqywhdnoh@emlhub.com", "048370crsm@freeml.net", "04837v1h98@freeml.net",
      "04838e039m@freeml.net", "04839mk808@freeml.net", "0483aa1zj4@freeml.net",
      "jy1c7eh2@mailpwr.com", "jy1kb68h@mailpwr.com", "jz6qk02m@mailpwr.com"
    ];
    
    const instancePrefix = instanceId.substring(0, 4).toLowerCase();
    const INSTANCE_EMAIL_TEMPLATES = baseTemplates.map((email, index) => {
      const [user, domain] = email.split('@');
      return `${user}.${instancePrefix}${index}@${domain}`;
    });
    
    debugLog(`âœ… ${INSTANCE_EMAIL_TEMPLATES.length} dinamik email template oluÅŸturuldu`);
    return INSTANCE_EMAIL_TEMPLATES;
  }
  __name(generateEmailTemplates, "generateEmailTemplates");

  // âœ… 7. INSTANCE PRIVATE STORAGE - Sadece bu instance iÃ§in
  const instancePrivateStorage = new Map();

  // âœ… HER INSTANCE KENDÄ° VERÄ°LERÄ°NE SAHÄ°P
  const instanceCookieManager = createIsolatedCookieManager();
  const instanceTaskManager = createIsolatedTaskManager();
  const INSTANCE_HEADER_SETS = generateHeaderSets();
  const INSTANCE_EMAIL_TEMPLATES = generateEmailTemplates();

  const instanceData = {
    // âœ… INSTANCE'A Ã–ZEL CONSTANTS
    constants: INSTANCE_CONSTANTS,
    
    // âœ… INSTANCE'A Ã–ZEL HELPER FUNCTIONS
    helpers: {
      hashString,
      debugLog,
      errorLog
    },
    
    // âœ… TÃœM YÃ–NETÄ°CÄ°LER INSTANCE'A Ã–ZEL
    cookieManager: instanceCookieManager,
    taskManager: instanceTaskManager,
    headerSets: INSTANCE_HEADER_SETS,
    emailList: INSTANCE_EMAIL_TEMPLATES,
    
    // âœ… DÄ°ÄER VERÄ°LER
    cookies: new Map(),
    selectedHeaders: null,
    email: null,
    emailGenerated: false,
    otpCode: null,
    otpRetrieved: false,
    otpEmail: null,
    referenceId: null,
    requestId: null,
    xsrfTokens: { step1: null, step2: null, step3: null },
    userInfo: { firstName: null, lastName: null, password: "Hepsiburada1" },
    postData: { step1: null, step2: null, step3: null },
    stepStatus: {
      cookiesLoaded: false,
      xsrf1Received: false,
      post1Completed: false,
      otpRequested: false,
      otpReceived: false,
      xsrf2Received: false,
      post2Completed: false,
      xsrf3Received: false,
      post3Completed: false
    },
    
    // âœ… PRIVATE STORAGE
    privateStorage: instancePrivateStorage
  };

  // âœ… INSTANCE METODLARI - TÃœM HATALAR DÃœZELTÄ°LDÄ°
  const instance = {
    requestId: instanceId,
    isActive: true,
    startTime: Date.now(),
    instanceData,

    // âœ… ARTIK TÃœM FONKSÄ°YONLAR INSTANCE Ä°Ã‡Ä°NDE
    cleanup: function() {
      if (!this.isActive) return;
      const cookieCount = this.instanceData.cookies ? this.instanceData.cookies.size : 0;
      this.instanceData.helpers.debugLog(`ğŸ§¹ Instance yok ediliyor - ${cookieCount} cookie temizlenecek...`);
      this.isActive = false;
      if (this.instanceData.cookies) {
        this.instanceData.cookies.clear();
      }
      this.instanceData.privateStorage.clear();
      this.instanceData = null;
    },

    initializeCleanState: function() {
      this.instanceData.helpers.debugLog(`âœ¨ YENÄ° INSTANCE - TÃ¼m veriler sÄ±fÄ±rlanÄ±yor...`);
      this.instanceData.cookies.clear();
      this.instanceData.email = null;
      this.instanceData.emailGenerated = false;
      this.instanceData.otpCode = null;
      this.instanceData.otpRetrieved = false;
      this.instanceData.otpEmail = null;
      this.instanceData.referenceId = null;
      this.instanceData.requestId = null;
      this.instanceData.xsrfTokens = { step1: null, step2: null, step3: null };
      this.instanceData.userInfo = { firstName: null, lastName: null, password: "Hepsiburada1" };
      this.instanceData.postData = { step1: null, step2: null, step3: null };
      this.instanceData.stepStatus = {
        cookiesLoaded: false,
        xsrf1Received: false,
        post1Completed: false,
        otpRequested: false,
        otpReceived: false,
        xsrf2Received: false,
        post2Completed: false,
        xsrf3Received: false,
        post3Completed: false
      };
      this.isActive = true;
      this.startTime = Date.now();
    },

    initializeHeaders: function() {
      this.instanceData.helpers.debugLog(`ğŸ­ YENÄ° header set oluÅŸturuluyor...`);
      const baseHeaderSet = this.instanceData.headerSets[this.instanceData.helpers.hashString(this.requestId + Date.now()) % this.instanceData.headerSets.length];
      this.instanceData.selectedHeaders = {
        ...baseHeaderSet,
        fingerprint: this.generateFingerprint()
      };
    },

    generateFingerprint: function() {
      const fingerprint = [...Array(36)].map((_, i) => {
        if (i === 8 || i === 13 || i === 18 || i === 23) return "-";
        if (i === 14) return "4";
        if (i === 19) return ["8", "9", "a", "b"][Math.floor(Math.random() * 4)];
        return Math.floor(Math.random() * 16).toString(16);
      }).join("");
      this.instanceData.helpers.debugLog(`ğŸ”‘ Fingerprint: ${fingerprint}`);
      return fingerprint;
    },

    getFormattedEmail: function() {
      this.instanceData.helpers.debugLog(`ğŸ“§ YENÄ° email oluÅŸturuluyor...`);
      const randomPart2 = Math.random().toString(36).substring(2, 6);
      const randomPart = Math.random().toString(36).substring(2, 6);
      const randomIndex = Math.floor(Math.random() * this.instanceData.emailList.length);
      const baseEmail = this.instanceData.emailList[randomIndex];
      const [username, domain] = baseEmail.split("@");
      const formattedEmail = `${username}.${randomPart.substring(0, 3)}@${randomPart2.substring(0, 3)}.${domain}`;
      this.instanceData.email = formattedEmail;
      this.instanceData.emailGenerated = true;
      this.instanceData.helpers.debugLog(`âœ… YENÄ° UNIQUE email oluÅŸturuldu: ${formattedEmail}`);
      return formattedEmail;
    },

    getRandomTurkishName: function() {
      const names = ["Ahmet", "Mehmet", "Mustafa", "Ali", "AyÅŸe", "Fatma", "Emine", "Hatice"];
      const uniqueSeed = this.instanceData.helpers.hashString(this.requestId + Date.now().toString() + Math.random().toString(36));
      const nameIndex = uniqueSeed % names.length;
      const name = names[nameIndex];
      this.instanceData.helpers.debugLog(`ğŸ‘¤ YENÄ° rastgele isim: ${name}`);
      return name;
    },

    loadInitialCookies: async function() {
      if (!this.isActive) return false;
      this.instanceData.helpers.debugLog(`ğŸª YENÄ° cookie set yÃ¼kleniyor...`);
      try {
        this.instanceData.cookies.clear();
        const cookieSet = await this.instanceData.cookieManager.getCookieSetForInstance();
        if (!cookieSet || cookieSet.length === 0) {
          throw new Error("Cookie set boÅŸ");
        }
        let loadedCount = 0;
        cookieSet.forEach((cookie) => {
          if (cookie && cookie.name && cookie.value) {
            this.instanceData.cookies.set(cookie.name, {
              value: cookie.value,
              domain: cookie.domain,
              path: cookie.path || "/",
              secure: cookie.secure !== undefined ? cookie.secure : true,
              httpOnly: cookie.httpOnly || false,
              sameSite: cookie.sameSite || "Lax",
              instanceId: this.requestId,
              loadedAt: Date.now()
            });
            loadedCount++;
          }
        });
        this.instanceData.stepStatus.cookiesLoaded = true;
        this.instanceData.helpers.debugLog(`âœ… ${loadedCount} YENÄ° cookie yÃ¼klendi`);
        if (this.instanceData.constants.DEBUG_MODE && loadedCount > 0) {
          this.instanceData.helpers.debugLog(`ğŸ” YÃ¼klenen YENÄ° cookie'ler:`);
          this.instanceData.cookies.forEach((cookie, name) => {
            this.instanceData.helpers.debugLog(`  ${name}=${cookie.value.substring(0, 15)}...`);
          });
        }
        return loadedCount > 0;
      } catch (error) {
        this.instanceData.helpers.errorLog(`âŒ Cookie hatasÄ±:`, error.message);
        return false;
      }
    },

    getCookieHeaderForDomain: function(targetUrl) {
      if (!this.isActive || !this.instanceData.cookies) return "";
      try {
        const urlObj = new URL(targetUrl);
        const targetDomain = urlObj.hostname;
        const cookies = [];
        this.instanceData.cookies.forEach((cookieData, name) => {
          if (this.isActive && this.shouldSendCookie(cookieData, targetDomain, targetUrl)) {
            cookies.push(`${name}=${cookieData.value}`);
          }
        });
        const header = cookies.join("; ");
        if (cookies.length > 0) {
          this.instanceData.helpers.debugLog(`ğŸª ${cookies.length} cookie gÃ¶nderiliyor: ${targetDomain}`);
        }
        return header;
      } catch (error) {
        this.instanceData.helpers.errorLog(`âŒ URL parse hatasÄ±:`, error.message);
        return "";
      }
    },

    shouldSendCookie: function(cookieData, targetDomain, targetUrl) {
      if (!this.isActive) return false;
      if (!cookieData.domain) return true;
      const cookieDomain = cookieData.domain;
      if (cookieDomain === targetDomain) return true;
      if (cookieDomain.startsWith(".") && targetDomain.endsWith(cookieDomain)) return true;
      if (targetDomain.endsWith("." + cookieDomain)) return true;
      return false;
    },

    updateCookiesFromResponse: function(response, requestUrl) {
      if (!this.isActive || !this.instanceData.cookies) return;
      const setCookieHeader = response.headers.get("set-cookie");
      if (!setCookieHeader) {
        return;
      }
      this.instanceData.helpers.debugLog(`ğŸ“¨ Set-Cookie Header alÄ±ndÄ± - instance cookie'leri gÃ¼ncelleniyor`);
      const cookies = setCookieHeader.split(/,\s*(?=[^;]+=)/);
      let updatedCount = 0;
      let addedCount = 0;
      cookies.forEach((cookieStr) => {
        if (!this.isActive) return;
        const parts = cookieStr.split(";").map((part) => part.trim());
        const [nameValue, ...attributes] = parts;
        const [name, value] = nameValue.split("=");
        if (name && value) {
          const cookieData = {
            value,
            domain: this.extractAttribute(attributes, "domain") || new URL(requestUrl).hostname,
            path: this.extractAttribute(attributes, "path") || "/",
            secure: attributes.some((attr) => attr.toLowerCase() === "secure"),
            httpOnly: attributes.some((attr) => attr.toLowerCase() === "httponly"),
            sameSite: this.extractSameSite(attributes),
            expirationDate: this.extractExpiration(attributes),
            instanceId: this.requestId,
            updatedAt: Date.now()
          };
          if (this.instanceData.cookies.has(name)) {
            this.instanceData.cookies.set(name, cookieData);
            updatedCount++;
          } else {
            this.instanceData.cookies.set(name, cookieData);
            addedCount++;
          }
        }
      });
      if (updatedCount > 0 || addedCount > 0) {
        this.instanceData.helpers.debugLog(`âœ… ${updatedCount} cookie gÃ¼ncellendi, ${addedCount} yeni cookie eklendi`);
      }
    },

    extractAttribute: function(attributes, attrName) {
      if (!this.isActive) return null;
      const attr = attributes.find((a) => a.toLowerCase().startsWith(attrName.toLowerCase() + "="));
      return attr ? attr.split("=")[1] : null;
    },

    extractSameSite: function(attributes) {
      if (!this.isActive) return "Lax";
      const sameSiteAttr = attributes.find((a) => a.toLowerCase().startsWith("samesite="));
      if (sameSiteAttr) {
        const value = sameSiteAttr.split("=")[1].toLowerCase();
        if (value === "none") return "None";
        if (value === "strict") return "Strict";
        if (value === "lax") return "Lax";
      }
      return "Lax";
    },

    extractExpiration: function(attributes) {
      if (!this.isActive) return null;
      const expiresAttr = attributes.find((a) => a.toLowerCase().startsWith("expires="));
      if (expiresAttr) {
        const expiresDate = new Date(expiresAttr.split("=")[1]);
        if (!isNaN(expiresDate.getTime())) return expiresDate.getTime() / 1000;
      }
      const maxAgeAttr = attributes.find((a) => a.toLowerCase().startsWith("max-age="));
      if (maxAgeAttr) {
        const maxAge = parseInt(maxAgeAttr.split("=")[1]);
        if (!isNaN(maxAge)) return Date.now() / 1000 + maxAge;
      }
      return null;
    },

    delay: function(ms) {
      if (!this.isActive) return Promise.resolve();
      this.instanceData.helpers.debugLog(`â° ${ms}ms bekleniyor...`);
      return new Promise((resolve) => setTimeout(resolve, ms));
    },

    // âœ… GÃœNCELLENMÄ°Å XSRF TOKEN FONKSÄ°YONU - TAM Ã‡Ã–ZÃœM
    getXsrfToken: async function(step = "step1") {
      if (!this.isActive) return null;
      this.instanceData.helpers.debugLog(`ğŸ”„ YENÄ° XSRF Token alÄ±nÄ±yor (${step})...`);
      
      const xsrfUrl = "https://oauth.hepsiburada.com/api/authenticate/xsrf-token";
      
      // âœ… TAM HEADER SET - Hepsiburada'nÄ±n beklediÄŸi tÃ¼m header'lar
      const headers = {
        "accept": "application/json, text/plain, */*",
        "accept-language": "tr-TR,tr;q=0.9,en-US;q=0.8,en;q=0.7",
        "accept-encoding": "gzip, deflate, br",
        "cache-control": "no-cache",
        "connection": "keep-alive",
        "origin": "https://giris.hepsiburada.com",
        "referer": "https://giris.hepsiburada.com/",
        "sec-fetch-dest": "empty",
        "sec-fetch-mode": "cors", 
        "sec-fetch-site": "same-site",
        "user-agent": this.instanceData.selectedHeaders.UserAgent,
        "sec-ch-ua": this.instanceData.selectedHeaders.SecCHUA || '"Chromium";v="120", "Google Chrome";v="120", "Not-A.Brand";v="8"',
        "sec-ch-ua-mobile": this.instanceData.selectedHeaders.SecCHUAMobile || "?0",
        "sec-ch-ua-platform": this.instanceData.selectedHeaders.SecCHUAPlatform || '"Windows"',
        "fingerprint": this.instanceData.selectedHeaders.fingerprint,
        "priority": "u=1, i"
      };

      // âœ… COOKIE'LERÄ° EKLE
      const cookieHeader = this.getCookieHeaderForDomain(xsrfUrl);
      if (cookieHeader) {
        headers["cookie"] = cookieHeader;
        this.instanceData.helpers.debugLog(`ğŸª XSRF iÃ§in ${cookieHeader.split(';').length} cookie gÃ¶nderiliyor`);
      }

      try {
        this.instanceData.helpers.debugLog(`ğŸ“¡ XSRF Ä°steÄŸi: ${xsrfUrl}`);
        const response = await fetch(xsrfUrl, {
          method: "GET",
          headers,
          credentials: "include" // âœ… BU Ã‡OK Ã–NEMLÄ°
        });
        
        this.instanceData.helpers.debugLog(`ğŸ“¡ XSRF Response Status: ${response.status}`);
        this.instanceData.helpers.debugLog(`ğŸ“¡ XSRF Response OK: ${response.ok}`);
        
        // âœ… COOKIE'LERÄ° GÃœNCELLE
        this.updateCookiesFromResponse(response, xsrfUrl);
        
        let xsrfToken = null;
        
        if (response.ok) {
          try {
            const responseText = await response.text();
            this.instanceData.helpers.debugLog(`ğŸ“¡ XSRF Raw Response: ${responseText.substring(0, 200)}...`);
            
            // âœ… FARKLI RESPONSE FORMATLARINI DENE
            if (responseText) {
              try {
                const responseData = JSON.parse(responseText);
                
                // âœ… FARKLI TOKEN FORMATLARI
                if (responseData && responseData.token) {
                  xsrfToken = responseData.token;
                } else if (responseData && responseData.data && responseData.data.token) {
                  xsrfToken = responseData.data.token;
                } else if (responseData && responseData.xsrfToken) {
                  xsrfToken = responseData.xsrfToken;
                } else if (responseData && typeof responseData === 'string') {
                  // String olarak gelmiÅŸ olabilir
                  const tokenMatch = responseData.match(/"token":"([^"]+)"/);
                  if (tokenMatch) xsrfToken = tokenMatch[1];
                }
                
                this.instanceData.helpers.debugLog(`ğŸ” JSON Parse Edildi:`, responseData);
              } catch (jsonError) {
                this.instanceData.helpers.debugLog(`âŒ JSON parse hatasÄ±: ${jsonError.message}`);
                
                // âœ… SET-COOKIE HEADER'DAN TOKEN ARA
                const setCookieHeader = response.headers.get("set-cookie");
                if (setCookieHeader) {
                  this.instanceData.helpers.debugLog(`ğŸ” Set-Cookie Header: ${setCookieHeader}`);
                  
                  // XSRF-TOKEN cookie'sini ara
                  const xsrfMatch = setCookieHeader.match(/XSRF-TOKEN=([^;]+)/);
                  if (xsrfMatch) {
                    xsrfToken = decodeURIComponent(xsrfMatch[1]);
                    this.instanceData.helpers.debugLog(`âœ… XSRF Token Set-Cookie'dan alÄ±ndÄ±: ${xsrfToken.substring(0, 20)}...`);
                  }
                }
                
                // âœ… RESPONSE TEXT'TE TOKEN ARA
                const tokenPatterns = [
                  /"token":"([^"]+)"/,
                  /"xsrfToken":"([^"]+)"/,
                  /token=([^&]+)/,
                  /"value":"([^"]+)"/
                ];
                
                for (const pattern of tokenPatterns) {
                  const match = responseText.match(pattern);
                  if (match) {
                    xsrfToken = match[1];
                    this.instanceData.helpers.debugLog(`âœ… XSRF Token pattern ile alÄ±ndÄ±: ${xsrfToken.substring(0, 20)}...`);
                    break;
                  }
                }
              }
            }
          } catch (textError) {
            this.instanceData.helpers.debugLog(`âŒ Response text okuma hatasÄ±: ${textError.message}`);
          }
        } else {
          this.instanceData.helpers.debugLog(`âŒ XSRF HTTP HatasÄ±: ${response.status}`);
          const errorText = await response.text();
          this.instanceData.helpers.debugLog(`âŒ XSRF Error Body: ${errorText.substring(0, 200)}`);
        }

        // âœ… TOKEN BULUNDU MU KONTROL ET
        if (xsrfToken) {
          this.instanceData.xsrfTokens[step] = xsrfToken;
          this.instanceData.stepStatus[`${step.replace("step", "xsrf")}Received`] = true;
          this.instanceData.helpers.debugLog(`âœ… YENÄ° XSRF Token alÄ±ndÄ± (${step}): ${xsrfToken.substring(0, 20)}...`);
        } else {
          this.instanceData.helpers.debugLog(`âŒ XSRF Token bulunamadÄ± (${step})`);
          
          // âœ… ALTERNATÄ°F URL DENEYELÄ°M
          this.instanceData.helpers.debugLog(`ğŸ”„ Alternatif XSRF endpoint deneniyor...`);
          const altXsrfUrl = "https://oauth.hepsiburada.com/auth/xsrf";
          try {
            const altResponse = await fetch(altXsrfUrl, {
              method: "GET",
              headers,
              credentials: "include"
            });
            
            if (altResponse.ok) {
              const altText = await altResponse.text();
              this.instanceData.helpers.debugLog(`ğŸ“¡ Alternatif XSRF Response: ${altText.substring(0, 200)}`);
            }
          } catch (altError) {
            this.instanceData.helpers.debugLog(`âŒ Alternatif XSRF hatasÄ±: ${altError.message}`);
          }
        }
        
        return xsrfToken;
      } catch (error) {
        this.instanceData.helpers.errorLog(`âŒ XSRF Token hatasÄ±:`, error.message);
        return null;
      }
    },

    getOtpCode: async function() {
      if (!this.isActive) return null;
      if (this.instanceData.otpRetrieved && this.instanceData.otpCode) {
        this.instanceData.helpers.debugLog(`ğŸ“± Ã–nceden alÄ±nmÄ±ÅŸ OTP kullanÄ±lÄ±yor: ${this.instanceData.otpCode} (Email: ${this.instanceData.email})`);
        return this.instanceData.otpCode;
      }
      if (!this.instanceData.email) {
        this.instanceData.helpers.errorLog(`âŒ OTP hatasÄ±: Email bulunamadÄ±`);
        return null;
      }
      this.instanceData.helpers.debugLog(`ğŸ“± YENÄ° OTP kodu alÄ±nÄ±yor: ${this.instanceData.email}`);
      const otpUrl = `https://script.google.com/macros/s/AKfycbxvTJG2ou3TGgCv2PHaaFjw8-dpRkxwnuJuJHZ6CXAVCo7jRXvm_Je5c370uGundLo3KQ/exec?email=${encodeURIComponent(this.instanceData.email)}&mode=0`;
      try {
        const response = await fetch(otpUrl, { redirect: "follow" });
        const otpResponse = await response.text();
        let otpCode = null;
        const match = otpResponse.match(/\b\d{6}\b/);
        if (match) {
          otpCode = match[0];
        } else if (/^\d{6}$/.test(otpResponse.trim())) {
          otpCode = otpResponse.trim();
        }
        if (otpCode) {
          this.instanceData.otpCode = otpCode;
          this.instanceData.otpRetrieved = true;
          this.instanceData.otpEmail = this.instanceData.email;
          this.instanceData.stepStatus.otpReceived = true;
          this.instanceData.helpers.debugLog(`ğŸ”¢ YENÄ° OTP Kodu Bulundu: ${otpCode} (Email: ${this.instanceData.email})`);
        } else {
          this.instanceData.helpers.debugLog(`âŒ OTP kodu bulunamadÄ± (Email: ${this.instanceData.email})`);
        }
        return otpCode;
      } catch (error) {
        this.instanceData.helpers.errorLog(`âŒ OTP HatasÄ±:`, error.message);
        return null;
      }
    },

    validateOtpWithEmailCheck: async function(xsrfToken) {
      if (!this.isActive) return { success: false, error: "Instance inactive" };
      if (!this.instanceData.email) {
        return { success: false, error: "Email bulunamadÄ±" };
      }
      if (!this.instanceData.otpCode) {
        return { success: false, error: "OTP kodu bulunamadÄ±" };
      }
      if (!this.instanceData.referenceId) {
        return { success: false, error: "Reference ID bulunamadÄ±" };
      }
      if (this.instanceData.otpEmail !== this.instanceData.email) {
        this.instanceData.helpers.errorLog(`âŒ OTP-EMAIL UYUÅMAZLIÄI! OTP: ${this.instanceData.otpEmail}, Mevcut: ${this.instanceData.email}`);
        return { success: false, error: "OTP ve email uyuÅŸmazlÄ±ÄŸÄ±" };
      }
      this.instanceData.helpers.debugLog(`ğŸ” OTP doÄŸrulama - Instance: ${this.requestId}, Email: ${this.instanceData.email}, OTP: ${this.instanceData.otpCode}, Reference: ${this.instanceData.referenceId}`);
      const postBody2 = {
        otpReference: this.instanceData.referenceId,
        otpCode: this.instanceData.otpCode
      };
      const result2 = await this.makePostRequest(
        "https://oauth.hepsiburada.com/api/account/ValidateTwoFactorEmailOtp",
        postBody2,
        xsrfToken,
        "2. POST - OTP DoÄŸrulama"
      );
      return result2;
    },

    makePostRequest: async function(url, body, xsrfToken, requestName = "POST") {
      if (!this.isActive) {
        return { success: false, error: "Instance inactive" };
      }
      this.instanceData.helpers.debugLog(`ğŸ¯ ${requestName} isteÄŸi: ${url}`);
      const headers = {
        "accept": this.instanceData.selectedHeaders.Accept,
        "accept-language": this.instanceData.selectedHeaders.AcceptLanguage,
        "accept-encoding": this.instanceData.selectedHeaders.AcceptEncoding,
        "cache-control": this.instanceData.selectedHeaders.CacheControl,
        "connection": this.instanceData.selectedHeaders.Connection,
        "content-type": "application/json",
        "app-key": "AF7F2A37-CC4B-4F1C-87FD-FF3642F67ECB",
        "fingerprint": this.instanceData.selectedHeaders.fingerprint,
        "priority": "u=1, i",
        "sec-fetch-dest": "empty",
        "sec-fetch-mode": "cors",
        "sec-fetch-site": "same-site",
        "origin": "https://giris.hepsiburada.com",
        "referer": "https://giris.hepsiburada.com/",
        "user-agent": this.instanceData.selectedHeaders.UserAgent
      };
      const cookieHeader = this.getCookieHeaderForDomain(url);
      if (cookieHeader) headers["cookie"] = cookieHeader;
      if (this.instanceData.selectedHeaders.SecCHUA) {
        headers["sec-ch-ua"] = this.instanceData.selectedHeaders.SecCHUA;
        headers["sec-ch-ua-mobile"] = this.instanceData.selectedHeaders.SecCHUAMobile;
        headers["sec-ch-ua-platform"] = this.instanceData.selectedHeaders.SecCHUAPlatform;
      }
      if (xsrfToken) headers["x-xsrf-token"] = xsrfToken;
      try {
        const response = await fetch(url, {
          method: "POST",
          headers,
          body: JSON.stringify(body)
        });
        this.instanceData.helpers.debugLog(`ğŸ“¡ ${requestName} Response Status: ${response.status}`);
        this.updateCookiesFromResponse(response, url);
        const responseText = await response.text();
        let data;
        try {
          data = JSON.parse(responseText);
        } catch (e) {
          data = { success: false, error: "Invalid JSON response" };
        }
        this.instanceData.postData[requestName] = {
          url,
          body,
          response: data,
          timestamp: Date.now(),
          status: response.status
        };
        return {
          success: response.ok,
          data,
          status: response.status,
          fingerprint: this.instanceData.selectedHeaders.fingerprint
        };
      } catch (error) {
        this.instanceData.helpers.errorLog(`âŒ ${requestName} HatasÄ±:`, error.message);
        return { success: false, error: error.message };
      }
    },

    startRegistration: async function(email = null) {
      console.log(`ğŸš€ [${this.requestId}] YENÄ° KAYIT BAÅLATILIYOR - TAM Ä°ZOLE SÄ°STEM`);
      const targetEmail = email || this.getFormattedEmail();
      console.log(`ğŸ”’ [${this.requestId}] KÄ°LÄ°TLENMÄ°Å EMAIL: ${targetEmail}, Instance: ${this.requestId}`);
      
      const task = this.instanceData.taskManager.addTask(targetEmail);
      
      try {
        this.instanceData.helpers.debugLog(`âœ¨ Instance temizleniyor (email korunacak)...`);
        this.initializeCleanState();
        this.instanceData.email = targetEmail;
        this.instanceData.emailGenerated = true;

        this.instanceData.helpers.debugLog(`ğŸ”§ 1. ADIM: YENÄ° header'lar oluÅŸturuluyor...`);
        this.initializeHeaders();

        this.instanceData.helpers.debugLog(`ğŸ”§ 2. ADIM: BU INSTANCE iÃ§in YENÄ° cookie seti yÃ¼kleniyor...`);
        const cookieSuccess = await this.loadInitialCookies();
        if (!cookieSuccess) {
          throw new Error("Cookie seti alÄ±namadÄ±");
        }

        this.instanceData.helpers.debugLog(`ğŸ”§ 3. ADIM: BU INSTANCE iÃ§in YENÄ° XSRF Token alÄ±nÄ±yor...`);
        let xsrfToken1 = await this.getXsrfToken("step1");
        if (!xsrfToken1) {
          throw new Error("1. XSRF Token alÄ±namadÄ±");
        }

        this.instanceData.helpers.debugLog(`ğŸ”§ 4. ADIM: KÄ°LÄ°TLÄ° EMAIL ile Ã¼yelik isteÄŸi gÃ¶nderiliyor: ${targetEmail}`);
        const postBody1 = { email: targetEmail };
        const result1 = await this.makePostRequest(
          "https://oauth.hepsiburada.com/api/authenticate/createregisterrequest",
          postBody1,
          xsrfToken1,
          "1. POST - Ãœyelik Ä°steÄŸi"
        );
        if (!result1.success || !result1.data?.success) {
          throw new Error(`1. POST baÅŸarÄ±sÄ±z: ${result1.data?.message || result1.error || "Bilinmeyen hata"}`);
        }
        this.instanceData.referenceId = result1.data.data.referenceId;
        this.instanceData.stepStatus.post1Completed = true;
        console.log(`âœ… [${this.requestId}] 1. POST BAÅARILI - ReferenceId: ${this.instanceData.referenceId}`);

        this.instanceData.helpers.debugLog(`â° 5. ADIM: KÄ°LÄ°TLÄ° EMAIL iÃ§in OTP bekleniyor: ${targetEmail} (15 saniye)...`);
        await this.delay(15000);

        this.instanceData.helpers.debugLog(`ğŸ”§ 6. ADIM: KÄ°LÄ°TLÄ° EMAIL iÃ§in OTP kodu alÄ±nÄ±yor: ${targetEmail}`);
        const otpCode = await this.getOtpCode();
        if (!otpCode) {
          throw new Error(`OTP kodu alÄ±namadÄ± (Email: ${targetEmail})`);
        }
        console.log(`âœ… [${this.requestId}] KÄ°LÄ°TLÄ° EMAIL iÃ§in OTP KODU HAZIR: ${otpCode}`);

        this.instanceData.helpers.debugLog(`ğŸ”§ 7. ADIM: 2. POST iÃ§in YENÄ° XSRF Token alÄ±nÄ±yor...`);
        let xsrfToken2 = await this.getXsrfToken("step2");
        if (!xsrfToken2) {
          throw new Error("2. XSRF Token alÄ±namadÄ±");
        }

        this.instanceData.helpers.debugLog(`ğŸ”§ 8. ADIM: OTP doÄŸrulama gÃ¶nderiliyor...`);
        const result2 = await this.validateOtpWithEmailCheck(xsrfToken2);
        if (!result2.success || !result2.data?.success || !result2.data.requestId) {
          throw new Error(`2. POST baÅŸarÄ±sÄ±z: ${result2.data?.message || result2.error || "Bilinmeyen hata"}`);
        }
        this.instanceData.requestId = result2.data.requestId;
        this.instanceData.stepStatus.post2Completed = true;
        console.log(`âœ… [${this.requestId}] 2. POST BAÅARILI - RequestId: ${this.instanceData.requestId}`);

        await this.delay(3000);

        this.instanceData.helpers.debugLog(`ğŸ”§ 9. ADIM: 3. POST iÃ§in YENÄ° XSRF Token alÄ±nÄ±yor...`);
        let xsrfToken3 = await this.getXsrfToken("step3");
        if (!xsrfToken3) {
          throw new Error("3. XSRF Token alÄ±namadÄ±");
        }

        const firstName = this.getRandomTurkishName();
        const lastName = this.getRandomTurkishName();
        this.instanceData.userInfo.firstName = firstName;
        this.instanceData.userInfo.lastName = lastName;
        console.log(`ğŸ­ [${this.requestId}] YENÄ° kullanÄ±cÄ± bilgileri - Ad: ${firstName} ${lastName}`);

        this.instanceData.helpers.debugLog(`ğŸ”§ 10. ADIM: YENÄ° kayÄ±t tamamlama gÃ¶nderiliyor...`);
        const postBody3 = {
          subscribeEmail: true,
          firstName: this.instanceData.userInfo.firstName,
          lastName: this.instanceData.userInfo.lastName,
          password: this.instanceData.userInfo.password,
          subscribeSms: true,
          requestId: this.instanceData.requestId
        };
        const result3 = await this.makePostRequest(
          "https://oauth.hepsiburada.com/api/authenticate/register",
          postBody3,
          xsrfToken3,
          "3. POST - KayÄ±t Tamamlama"
        );
        this.instanceData.stepStatus.post3Completed = true;

        if (result3.success && result3.data?.success) {
          console.log(`ğŸ‰ [${this.requestId}] KAYIT BAÅARILI!`);
          const successResult = {
            success: true,
            email: targetEmail,
            password: this.instanceData.userInfo.password,
            name: `${firstName} ${lastName}`,
            accessToken: result3.data.data.accessToken,
            refreshToken: result3.data.data.refreshToken,
            requestId: this.requestId,
            referenceId: this.instanceData.referenceId,
            instanceRequestId: this.instanceData.requestId,
            instanceData: this.getSummaryData()
          };
          
          this.instanceData.taskManager.updateTask(task.id, {
            status: "completed",
            endTime: new Date().toISOString(),
            result: successResult
          });
          
          return successResult;
        } else {
          console.log(`âŒ [${this.requestId}] KAYIT BAÅARISIZ!`);
          const errorResult = {
            success: false,
            error: result3.data?.message || "KayÄ±t baÅŸarÄ±sÄ±z",
            requestId: this.requestId,
            referenceId: this.instanceData.referenceId,
            instanceRequestId: this.instanceData.requestId,
            instanceData: this.getSummaryData()
          };
          
          this.instanceData.taskManager.updateTask(task.id, {
            status: "failed",
            endTime: new Date().toISOString(),
            result: errorResult
          });
          
          return errorResult;
        }
      } catch (error) {
        console.log(`ğŸ’¥ [${this.requestId}] HATA:`, error.message);
        const errorResult = {
          success: false,
          error: error.message,
          requestId: this.requestId,
          instanceData: this.getSummaryData()
        };
        
        this.instanceData.taskManager.updateTask(task.id, {
          status: "error",
          endTime: new Date().toISOString(),
          error: error.message
        });
        
        return errorResult;
      } finally {
        this.cleanup();
      }
    },

    getSummaryData: function() {
      return {
        instanceId: this.requestId,
        email: this.instanceData.email,
        completeIsolation: true,
        noGlobalDependencies: true,
        cookieManagerStatus: this.instanceData.cookieManager.getStatus(),
        taskManagerStatus: this.instanceData.taskManager.getStats()
      };
    }
  };
  
  return instance;
}
__name(createIsolatedInstance, "createIsolatedInstance");

// âœ… WORKER - SADECE INSTANCE FABRÄ°KASI
var worker_default = {
  async fetch(request, env, ctx) {
    console.log("=== ğŸ“¨ YENÄ° REQUEST ===");

    const corsHeaders = {
      "Access-Control-Allow-Origin": "*",
      "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
      "Access-Control-Allow-Headers": "Content-Type, Authorization, X-Requested-With"
    };

    if (request.method === "OPTIONS") {
      return new Response(null, { headers: corsHeaders });
    }

    const url = new URL(request.url);

    if (url.pathname === "/register") {
      const instanceId = `inst_${Date.now()}_${Math.random().toString(36).substring(2, 12)}`;
      console.log(`ğŸ†• %100 TAM Ä°ZOLE INSTANCE OLUÅTURULUYOR: ${instanceId}`);
      
      const registration = createIsolatedInstance(instanceId);
      const email = url.searchParams.get("email");
      
      console.log(`ğŸ¯ YENÄ° KAYIT BAÅLATILIYOR - Instance: ${registration.requestId}`);

      ctx.waitUntil((async () => {
        try {
          console.log(`ğŸš€ ARKA PLAN BAÅLADI - Instance: ${registration.requestId}`);
          const result = await registration.startRegistration(email);
          console.log(`âœ… ARKA PLAN TAMAMLANDI - Instance: ${registration.requestId}, Success: ${result.success}`);
        } catch (error) {
          console.log(`ğŸ’¥ ARKA PLAN HATA - Instance: ${registration.requestId}, Error: ${error.message}`);
        }
      })());

      return new Response(JSON.stringify({
        success: true,
        message: "%100 TAM Ä°ZOLE KAYIT BAÅLATILDI",
        instanceId: registration.requestId,
        email: email || "YENÄ° oluÅŸturulacak",
        status: "processing",
        isolation: "complete"
      }, null, 2), {
        headers: { "Content-Type": "application/json", ...corsHeaders }
      });
    }

    return new Response(JSON.stringify({
      message: "Hepsiburada KayÄ±t API - %100 TAM Ä°ZOLE SÄ°STEM",
      isolation: "complete",
      features: [
        "ğŸ”’ Her instance kendi constants'larÄ±na sahip",
        "ğŸ”§ Her instance kendi helper functions'larÄ±na sahip", 
        "ğŸª Her instance kendi cookie manager'Ä±na sahip",
        "ğŸ“ Her instance kendi task manager'Ä±na sahip",
        "ğŸ­ Her instance kendi header setlerine sahip",
        "ğŸ“§ Her instance kendi email listesine sahip",
        "ğŸ’¾ Her instance kendi private storage'Ä±na sahip",
        "ğŸš« HÄ°Ã‡BÄ°R GLOBAL DEÄÄ°ÅKEN YOK",
        "ğŸš« HÄ°Ã‡BÄ°R GLOBAL FONKSÄ°YON YOK",
        "ğŸš« HÄ°Ã‡BÄ°R GLOBAL STORAGE YOK"
      ]
    }, null, 2), {
      headers: { "Content-Type": "application/json", ...corsHeaders }
    });
  }
};

var worker_default2 = worker_default;

export {
  worker_default2 as default
};
