var __defProp = Object.defineProperty;
var __name = (target, value) => __defProp(target, "name", { value, configurable: true });

// worker.js
var EMAIL_LIST = [
  "jihpngpnd@emlhub.com",
  "tmrzfanje@emlpro.com", 
  "wiraypzse@emlpro.com",
  "lnmwhbvvf@emltmp.com",
  "bshuzcvvf@emltmp.com",
  "hsfsqxcug@emltmp.com",
  "nqywhdnoh@emlhub.com"
];

// COOKIE YÃ–NETÄ°MÄ° - TAMAMEN REQUEST BAZLI
const COOKIE_API_URL = "https://burnrndr.onrender.com/last-cookies";

// DEBUG MOD - PRODUCTION'DA KAPALI
const DEBUG_MODE = true; // Test iÃ§in aÃ§Ä±k

// OPTÄ°MÄ°ZE LOG FONKSÄ°YONLARI
function debugLog(...args) {
  if (DEBUG_MODE) console.log(...args);
}
function errorLog(...args) {
  console.log(...args);
}

// HEADER SET
var HEADER_SETS = [
  {
    "UserAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
    "SecCHUA": '"Chromium";v="120", "Google Chrome";v="120", "Not-A.Brand";v="8"',
    "SecCHUAMobile": "?0",
    "SecCHUAPlatform": '"Windows"',
    "Accept": "application/json, text/plain, */*",
    "AcceptLanguage": "tr-TR,tr;q=0.9,en-US;q=0.8,en;q=0.7",
    "AcceptEncoding": "gzip, deflate, br",
    "CacheControl": "no-cache",
    "Connection": "keep-alive"
  },
  {
    "UserAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36",
    "SecCHUA": '"Chromium";v="119", "Google Chrome";v="119", "Not-A.Brand";v="8"',
    "SecCHUAMobile": "?0",
    "SecCHUAPlatform": '"Windows"',
    "Accept": "application/json, text/plain, */*",
    "AcceptLanguage": "tr-TR,tr;q=0.9,en-US;q=0.8,en;q=0.7",
    "AcceptEncoding": "gzip, deflate, br",
    "CacheControl": "no-cache",
    "Connection": "keep-alive"
  }
];

// API COOKIE'LERÄ° ALMA - TAMAMEN BAÄIMSIZ
async function getManualCookiesForRequest(requestId) {
  debugLog(`ğŸ‘¤ [${requestId}] API Cookie alÄ±nÄ±yor`);
  
  const requestCookies = new Map();
  
  try {
    const response = await fetch(COOKIE_API_URL);
    if (!response.ok) throw new Error(`API hatasÄ±: ${response.status}`);
    
    const cookieData = await response.json();
    
    let cookiesArray;
    
    if (cookieData.set1 && Array.isArray(cookieData.set1)) {
      const setKeys = Object.keys(cookieData).filter(key => key.startsWith('set'));
      debugLog(`ğŸ” [${requestId}] Bulunan setler: ${setKeys.join(', ')}`);
      
      if (setKeys.length === 0) throw new Error("Cookie set bulunamadÄ±");
      
      const randomSetKey = setKeys[Math.floor(Math.random() * setKeys.length)];
      cookiesArray = cookieData[randomSetKey];
      debugLog(`ğŸ² [${requestId}] SeÃ§ilen cookie set: ${randomSetKey}`);
    } 
    else if (Array.isArray(cookieData)) {
      cookiesArray = cookieData;
      debugLog(`ğŸ“¥ [${requestId}] API'den ${cookiesArray.length} cookie alÄ±ndÄ±`);
    } else {
      throw new Error(`API formatÄ± beklenmiyor: ${typeof cookieData}`);
    }
    
    cookiesArray.forEach(cookie => {
      if (cookie.name && cookie.value) {
        requestCookies.set(cookie.name, {
          value: cookie.value,
          domain: cookie.domain,
          path: cookie.path || '/',
          secure: cookie.secure !== undefined ? cookie.secure : true,
          httpOnly: cookie.httpOnly || false,
          sameSite: cookie.sameSite || 'Lax',
          expirationDate: cookie.expires || cookie.expirationDate
        });
        debugLog(`âœ… [${requestId}] ${cookie.name} yÃ¼klendi`);
      }
    });
    
    debugLog(`ğŸ¯ [${requestId}] ${requestCookies.size} cookie yÃ¼klendi`);
    return requestCookies;
    
  } catch (error) {
    errorLog(`âŒ [${requestId}] Cookie alÄ±namadÄ±:`, error.message);
    return new Map();
  }
}
__name(getManualCookiesForRequest, "getManualCookiesForRequest");

// COOKIE HEADER OLUÅTURMA - REQUEST BAZLI
function getCookieHeaderForRequest(requestCookies, targetUrl, requestId) {
  try {
    const urlObj = new URL(targetUrl);
    const targetDomain = urlObj.hostname;
    const cookies = [];
    
    requestCookies.forEach((cookieData, name) => {
      if (shouldSendCookie(cookieData, targetDomain, targetUrl)) {
        cookies.push(`${name}=${cookieData.value}`);
      }
    });
    
    const header = cookies.join("; ");
    debugLog(`ğŸª [${requestId}] ${cookies.length} cookie gÃ¶nderiliyor: ${targetDomain}`);
    return header;
  } catch (error) {
    errorLog(`âŒ [${requestId}] URL parse hatasÄ±:`, error.message);
    return "";
  }
}
__name(getCookieHeaderForRequest, "getCookieHeaderForRequest");

// COOKIE GÃ–NDERME KURALLARI
function shouldSendCookie(cookieData, targetDomain, targetUrl) {
  if (!cookieData.domain) {
    return true;
  }
  
  const cookieDomain = cookieData.domain;
  
  if (cookieDomain === targetDomain) {
    return true;
  }
  
  if (cookieDomain.startsWith('.') && targetDomain.endsWith(cookieDomain)) {
    return true;
  }
  
  if (targetDomain.endsWith('.' + cookieDomain)) {
    return true;
  }
  
  return false;
}
__name(shouldSendCookie, "shouldSendCookie");

// COOKIE GÃœNCELLEME - REQUEST BAZLI
function updateCookiesFromResponseForRequest(requestCookies, response, requestUrl, requestId) {
  const setCookieHeader = response.headers.get("set-cookie");
  if (!setCookieHeader) {
    debugLog(`ğŸ“­ [${requestId}] Set-Cookie header yok`);
    return;
  }
  
  debugLog(`ğŸ“¨ [${requestId}] Set-Cookie Header alÄ±ndÄ±`);
  const cookies = setCookieHeader.split(/,\s*(?=[^;]+=)/);
  
  let updatedCount = 0;
  let addedCount = 0;
  
  cookies.forEach((cookieStr) => {
    const parts = cookieStr.split(';').map(part => part.trim());
    const [nameValue, ...attributes] = parts;
    const [name, value] = nameValue.split('=');
    
    if (name && value) {
      const cookieData = {
        value: value,
        domain: extractAttribute(attributes, 'domain') || new URL(requestUrl).hostname,
        path: extractAttribute(attributes, 'path') || '/',
        secure: attributes.some(attr => attr.toLowerCase() === 'secure'),
        httpOnly: attributes.some(attr => attr.toLowerCase() === 'httponly'),
        sameSite: extractSameSite(attributes),
        expirationDate: extractExpiration(attributes)
      };
      
      if (requestCookies.has(name)) {
        requestCookies.set(name, cookieData);
        debugLog(`ğŸ”„ [${requestId}] Cookie gÃ¼ncellendi: ${name}`);
        updatedCount++;
      } else {
        requestCookies.set(name, cookieData);
        debugLog(`â• [${requestId}] Yeni cookie eklendi: ${name}`);
        addedCount++;
      }
    }
  });
  
  debugLog(`âœ… [${requestId}] ${updatedCount} cookie gÃ¼ncellendi, ${addedCount} yeni cookie eklendi`);
}
__name(updateCookiesFromResponseForRequest, "updateCookiesFromResponseForRequest");

// HELPER FONKSÄ°YONLAR
function extractAttribute(attributes, attrName) {
  const attr = attributes.find(a => a.toLowerCase().startsWith(attrName.toLowerCase() + '='));
  return attr ? attr.split('=')[1] : null;
}
__name(extractAttribute, "extractAttribute");

function extractSameSite(attributes) {
  const sameSiteAttr = attributes.find(a => a.toLowerCase().startsWith('samesite='));
  if (sameSiteAttr) {
    const value = sameSiteAttr.split('=')[1].toLowerCase();
    if (value === 'none') return 'None';
    if (value === 'strict') return 'Strict';
    if (value === 'lax') return 'Lax';
  }
  return 'Lax';
}
__name(extractSameSite, "extractSameSite");

function extractExpiration(attributes) {
  const expiresAttr = attributes.find(a => a.toLowerCase().startsWith('expires='));
  if (expiresAttr) {
    const expiresDate = new Date(expiresAttr.split('=')[1]);
    if (!isNaN(expiresDate.getTime())) return expiresDate.getTime() / 1000;
  }
  
  const maxAgeAttr = attributes.find(a => a.toLowerCase().startsWith('max-age='));
  if (maxAgeAttr) {
    const maxAge = parseInt(maxAgeAttr.split('=')[1]);
    if (!isNaN(maxAge)) return Date.now() / 1000 + maxAge;
  }
  
  return null;
}
__name(extractExpiration, "extractExpiration");

// RANDOM HEADER GENERATOR
function getRandomHeaders(requestId) {
  const baseSet = HEADER_SETS[Math.floor(Math.random() * HEADER_SETS.length)];
  const fingerprint = getFingerprint();
  
  const headers = {
    ...baseSet,
    fingerprint: fingerprint
  };
  
  debugLog(`ğŸ­ [${requestId}] Header set seÃ§ildi`);
  return headers;
}
__name(getRandomHeaders, "getRandomHeaders");

// EMAIL FORMATLAMA
function getFormattedEmail() {
  const baseEmail = EMAIL_LIST[Math.floor(Math.random() * EMAIL_LIST.length)];
  const [username, domain] = baseEmail.split("@");
  const random1 = Math.random().toString(36).substring(2, 5);
  const random2 = Math.random().toString(36).substring(2, 5);
  return `${username}.${random1}@${random2}.${domain}`;
}
__name(getFormattedEmail, "getFormattedEmail");

// FINGERPRINT OLUÅTURMA
function getFingerprint() {
  const uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    const r = Math.random() * 16 | 0;
    const v = c == 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
  return uuid;
}
__name(getFingerprint, "getFingerprint");

// RASTGELE TÃœRK Ä°SMÄ°
function getRandomTurkishName() {
  const names = ["Ahmet", "Mehmet", "Mustafa", "Ali", "AyÅŸe", "Fatma", "Emine", "Hatice"];
  return names[Math.floor(Math.random() * names.length)];
}
__name(getRandomTurkishName, "getRandomTurkishName");

// DELAY FONKSÄ°YONU
function delay(ms, requestId) {
  debugLog(`â³ [${requestId}] ${ms}ms bekleniyor...`);
  return new Promise((resolve) => setTimeout(resolve, ms));
}
__name(delay, "delay");

// XSRF TOKEN ALMA - TAMAMEN BAÄIMSIZ
async function getXsrfTokenForRequest(selectedHeaders, requestCookies, requestId) {
  debugLog(`ğŸ”„ [${requestId}] XSRF Token alÄ±nÄ±yor...`);
  
  const xsrfUrl = "https://oauth.hepsiburada.com/api/authenticate/xsrf-token";
  
  const headers = {
    "accept": selectedHeaders.Accept,
    "accept-language": selectedHeaders.AcceptLanguage,
    "accept-encoding": selectedHeaders.AcceptEncoding,
    "cache-control": selectedHeaders.CacheControl,
    "connection": selectedHeaders.Connection,
    "origin": "https://giris.hepsiburada.com",
    "referer": "https://giris.hepsiburada.com/",
    "sec-fetch-dest": "empty",
    "sec-fetch-mode": "cors",
    "sec-fetch-site": "same-site",
    "user-agent": selectedHeaders.UserAgent
  };
  
  const cookieHeader = getCookieHeaderForRequest(requestCookies, xsrfUrl, requestId);
  if (cookieHeader) headers["cookie"] = cookieHeader;
  
  if (selectedHeaders.SecCHUA) {
    headers["sec-ch-ua"] = selectedHeaders.SecCHUA;
    headers["sec-ch-ua-mobile"] = selectedHeaders.SecCHUAMobile;
    headers["sec-ch-ua-platform"] = selectedHeaders.SecCHUAPlatform;
  }
  
  try {
    const response = await fetch(xsrfUrl, { 
      method: 'GET',
      headers 
    });
    
    debugLog(`ğŸ“¡ [${requestId}] XSRF Response Status: ${response.status}`);
    
    updateCookiesFromResponseForRequest(requestCookies, response, xsrfUrl, requestId);
    
    let xsrfToken = null;
    
    if (response.ok) {
      try {
        const responseData = await response.json();
        if (responseData && responseData.token) {
          xsrfToken = responseData.token;
          debugLog(`âœ… [${requestId}] XSRF Token alÄ±ndÄ±`);
        }
      } catch (e) {
        debugLog(`âŒ [${requestId}] XSRF JSON parse hatasÄ±`);
      }
    }
    
    const setCookieHeader = response.headers.get("set-cookie");
    if (setCookieHeader && !xsrfToken) {
      const xsrfMatch = setCookieHeader.match(/XSRF-TOKEN=([^;]+)/);
      if (xsrfMatch) {
        xsrfToken = decodeURIComponent(xsrfMatch[1]);
        debugLog(`âœ… [${requestId}] XSRF Token header'dan alÄ±ndÄ±`);
      }
    }
    
    if (!xsrfToken) {
      debugLog(`âŒ [${requestId}] XSRF Token bulunamadÄ±`);
    }
    
    return xsrfToken;
  } catch (error) {
    errorLog(`âŒ [${requestId}] XSRF Token hatasÄ±:`, error.message);
    return null;
  }
}
__name(getXsrfTokenForRequest, "getXsrfTokenForRequest");

// OTP KODU ALMA
async function getOtpCode(email, requestId) {
  const otpUrl = `https://script.google.com/macros/s/AKfycbxvTJG2ou3TGgCv2PHaaFjw8-dpRkxwnuJuJHZ6CXAVCo7jRXvm_Je5c370uGundLo3KQ/exec?email=${encodeURIComponent(email)}&mode=0`;
  debugLog(`ğŸ“± [${requestId}] OTP Kodu alÄ±nÄ±yor...`);
  
  try {
    const response = await fetch(otpUrl, { redirect: "follow" });
    const otpResponse = await response.text();
    
    let otpCode = null;
    const match = otpResponse.match(/\b\d{6}\b/);
    
    if (match) {
      otpCode = match[0];
    } else if (/^\d{6}$/.test(otpResponse.trim())) {
      otpCode = otpResponse.trim();
    }
    
    if (otpCode) {
      debugLog(`ğŸ”¢ [${requestId}] OTP Kodu Bulundu`);
    } else {
      debugLog(`âŒ [${requestId}] OTP kodu bulunamadÄ±`);
    }
    
    return otpCode;
  } catch (error) {
    errorLog(`âŒ [${requestId}] OTP HatasÄ±:`, error.message);
    return null;
  }
}
__name(getOtpCode, "getOtpCode");

// POST REQUEST - TAMAMEN BAÄIMSIZ
async function makePostRequestForRequest(url, body, xsrfToken, selectedHeaders, requestCookies, requestName, requestId) {
  debugLog(`ğŸ¯ [${requestId}] ${requestName} isteÄŸi: ${url}`);
  
  const currentFingerprint = selectedHeaders.fingerprint || getFingerprint();
  
  const headers = {
    "accept": selectedHeaders.Accept,
    "accept-language": selectedHeaders.AcceptLanguage,
    "accept-encoding": selectedHeaders.AcceptEncoding,
    "cache-control": selectedHeaders.CacheControl,
    "connection": selectedHeaders.Connection,
    "content-type": "application/json",
    "app-key": "AF7F2A37-CC4B-4F1C-87FD-FF3642F67ECB",
    "fingerprint": currentFingerprint,
    "priority": "u=1, i",
    "sec-fetch-dest": "empty",
    "sec-fetch-mode": "cors",
    "sec-fetch-site": "same-site",
    "origin": "https://giris.hepsiburada.com",
    "referer": "https://giris.hepsiburada.com/",
    "user-agent": selectedHeaders.UserAgent
  };
  
  const cookieHeader = getCookieHeaderForRequest(requestCookies, url, requestId);
  if (cookieHeader) headers["cookie"] = cookieHeader;
  
  if (selectedHeaders.SecCHUA) {
    headers["sec-ch-ua"] = selectedHeaders.SecCHUA;
    headers["sec-ch-ua-mobile"] = selectedHeaders.SecCHUAMobile;
    headers["sec-ch-ua-platform"] = selectedHeaders.SecCHUAPlatform;
  }
  
  if (xsrfToken) headers["x-xsrf-token"] = xsrfToken;
  
  try {
    const response = await fetch(url, {
      method: "POST",
      headers,
      body: JSON.stringify(body)
    });
    
    debugLog(`ğŸ“¡ [${requestId}] ${requestName} Response Status: ${response.status}`);
    
    updateCookiesFromResponseForRequest(requestCookies, response, url, requestId);
    
    const responseText = await response.text();
    
    let data;
    try {
      data = JSON.parse(responseText);
    } catch (e) {
      data = { success: false, error: "Invalid JSON response" };
    }
    
    return {
      success: response.ok,
      data,
      status: response.status,
      fingerprint: currentFingerprint
    };
  } catch (error) {
    errorLog(`âŒ [${requestId}] ${requestName} HatasÄ±:`, error.message);
    return { success: false, error: error.message };
  }
}
__name(makePostRequestForRequest, "makePostRequestForRequest");

// ANA KAYIT FONKSÄ°YONU - TAMAMEN BAÄIMSIZ
async function processRegistration(email, useManualCookies = false) {
  const requestId = Math.random().toString(36).substring(2, 10);
  
  console.log(`ğŸš€ [${requestId}] KAYIT BAÅLATILIYOR - EMAIL: ${email}`);
  
  // âš¡ HER REQUEST KENDÄ° BAÄIMSIZ STATE'Ä°NE SAHÄ°P
  const requestCookies = new Map();
  const requestHeaders = getRandomHeaders(requestId);
  
  try {
    debugLog(`\nğŸ”§ [${requestId}] 1. ADIM: Cookie'ler yÃ¼kleniyor...`);
    const freshCookies = await getManualCookiesForRequest(requestId);
    
    // Cookie'leri bu request'e kopyala
    freshCookies.forEach((value, key) => {
      requestCookies.set(key, value);
    });
    
    if (requestCookies.size === 0) {
      throw new Error("Cookie'ler alÄ±namadÄ±");
    }
    
    debugLog(`\nğŸ”§ [${requestId}] 2. ADIM: XSRF Token alÄ±nÄ±yor...`);
    let xsrfToken1 = await getXsrfTokenForRequest(requestHeaders, requestCookies, requestId);
    if (!xsrfToken1) {
      throw new Error("1. XSRF Token alÄ±namadÄ±");
    }
    
    debugLog(`\nğŸ”§ [${requestId}] 3. ADIM: Ãœyelik isteÄŸi gÃ¶nderiliyor...`);
    const postBody1 = {
      email,
      returnUrl: "https://oauth.hepsiburada.com/connect/authorize/callback?client_id=SPA&redirect_uri=https%3A%2F%2Fwww.hepsiburada.com%2Fuyelik%2Fcallback&response_type=code&scope=openid%20profile&state=c7ca3f6c28c5445aa5c1f4d52ce65d6d&code_challenge=t44-iDRkzoBssUdCS9dHN3YZBks8RTWlxV-BpC4Jbos&code_challenge_method=S256&response_mode=query"
    };
    
    const result1 = await makePostRequestForRequest(
      "https://oauth.hepsiburada.com/api/authenticate/createregisterrequest",
      postBody1,
      xsrfToken1,
      requestHeaders,
      requestCookies,
      "1. POST - Ãœyelik Ä°steÄŸi",
      requestId
    );
    
    if (!result1.success || !result1.data?.success) {
      throw new Error(`1. POST baÅŸarÄ±sÄ±z: ${result1.data?.message || result1.error || 'Bilinmeyen hata'}`);
    }
    
    debugLog(`ğŸ‰ [${requestId}] 1. POST BAÅARILI`);
    
    debugLog(`\nâ³ [${requestId}] 4. ADIM: OTP bekleniyor (15 saniye)...`);
    await delay(15000, requestId);
    
    debugLog(`\nğŸ”§ [${requestId}] 5. ADIM: OTP kodu alÄ±nÄ±yor...`);
    const otpCode = await getOtpCode(email, requestId);
    
    if (!otpCode) {
      throw new Error("OTP kodu alÄ±namadÄ±");
    }
    
    debugLog(`âœ… [${requestId}] OTP KODU HAZIR`);
    
    debugLog(`\nğŸ”§ [${requestId}] 6. ADIM: 2. POST iÃ§in XSRF Token alÄ±nÄ±yor...`);
    let xsrfToken2 = await getXsrfTokenForRequest(requestHeaders, requestCookies, requestId);
    if (!xsrfToken2) {
      throw new Error("2. XSRF Token alÄ±namadÄ±");
    }
    
    const postBody2 = {
      otpReference: result1.data.data.referenceId,
      otpCode
    };
    
    const result2 = await makePostRequestForRequest(
      "https://oauth.hepsiburada.com/api/account/ValidateTwoFactorEmailOtp",
      postBody2,
      xsrfToken2,
      requestHeaders,
      requestCookies,
      "2. POST - OTP DoÄŸrulama",
      requestId
    );
    
    if (!result2.success || !result2.data?.success || !result2.data.requestId) {
      throw new Error(`2. POST baÅŸarÄ±sÄ±z: ${result2.data?.message || result2.error || 'Bilinmeyen hata'}`);
    }
    
    debugLog(`ğŸ‰ [${requestId}] 2. POST BAÅARILI`);
    
    debugLog(`\nâ³ [${requestId}] 7. ADIM: KayÄ±t Ã¶ncesi bekleniyor (3 saniye)...`);
    await delay(3000, requestId);
    
    debugLog(`\nğŸ”§ [${requestId}] 8. ADIM: 3. POST iÃ§in XSRF Token alÄ±nÄ±yor...`);
    let xsrfToken3 = await getXsrfTokenForRequest(requestHeaders, requestCookies, requestId);
    if (!xsrfToken3) {
      throw new Error("3. XSRF Token alÄ±namadÄ±");
    }
    
    const firstName = getRandomTurkishName();
    const lastName = getRandomTurkishName();
    const password = "Hepsiburada1";
    
    debugLog(`ğŸ­ [${requestId}] KullanÄ±cÄ± bilgileri hazÄ±r`);
    
    const postBody3 = {
      subscribeEmail: true,
      firstName,
      lastName,
      password,
      subscribeSms: true,
      returnUrl: "https://oauth.hepsiburada.com/connect/authorize/callback?client_id=SPA&redirect_uri=https%3A%2F%2Fwww.hepsiburada.com%2Fuyelik%2Fcallback&response_type=code&scope=openid%20profile&state=c7ca3f6c28c5445aa5c1f4d52ce65d6d&code_challenge=t44-iDRkzoBssUdCS9dHN3YZBks8RTWlxV-BpC4Jbos&code_challenge_method=S256&response_mode=query",
      requestId: result2.data.requestId
    };
    
    const result3 = await makePostRequestForRequest(
      "https://oauth.hepsiburada.com/api/authenticate/register",
      postBody3,
      xsrfToken3,
      requestHeaders,
      requestCookies,
      "3. POST - KayÄ±t Tamamlama",
      requestId
    );
    
    if (result3.success && result3.data?.success) {
      console.log(`ğŸ‰ ğŸ‰ ğŸ‰ [${requestId}] KAYIT BAÅARILI! ğŸ‰ ğŸ‰ ğŸ‰`);
      
      return {
        success: true,
        email,
        password,
        name: `${firstName} ${lastName}`,
        accessToken: result3.data.data.accessToken,
        refreshToken: result3.data.data.refreshToken,
        mode: useManualCookies ? "manual" : "auto",
        requestId: requestId
      };
    } else {
      console.log(`âŒ [${requestId}] KAYIT BAÅARISIZ!`);
      
      return { 
        success: false, 
        error: result3.data?.message || "KayÄ±t baÅŸarÄ±sÄ±z",
        mode: useManualCookies ? "manual" : "auto",
        requestId: requestId
      };
    }
    
  } catch (error) {
    console.log(`ğŸ’¥ [${requestId}] HATA:`, error.message);
    
    return { 
      success: false, 
      error: error.message,
      mode: useManualCookies ? "manual" : "auto",
      requestId: requestId
    };
  } finally {
    debugLog(`ğŸ”„ [${requestId}] Ä°ÅŸlem tamamlandÄ±`);
    // RequestCookies Map'i garbage collection ile otomatik temizlenir
  }
}
__name(processRegistration, "processRegistration");

// WORKER - TAM Ã‡OKLU Ä°STEK DESTEKLÄ°
var worker_default = {
  async fetch(request, env, ctx) {
    debugLog("ğŸ“¥ Yeni request:", request.method, request.url);
    
    const corsHeaders = {
      "Access-Control-Allow-Origin": "*",
      "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
      "Access-Control-Allow-Headers": "Content-Type, Authorization, X-Requested-With"
    };
    
    if (request.method === "OPTIONS") {
      return new Response(null, { headers: corsHeaders });
    }
    
    const url = new URL(request.url);
    
    if (url.pathname === "/register") {
      try {
        const email = url.searchParams.get("email") || getFormattedEmail();
        const manualMode = url.searchParams.get("manual") === "true" || true;
        
        console.log("ğŸ¯ KayÄ±t baÅŸlatÄ±lÄ±yor:", email);
        
        // âœ… HER REQUEST TAMAMEN BAÄIMSIZ
        const result = await processRegistration(email, manualMode);
        
        return new Response(JSON.stringify(result, null, 2), {
          headers: { 
            "Content-Type": "application/json", 
            ...corsHeaders 
          }
        });
      } catch (error) {
        errorLog("ğŸ’¥ API hatasÄ±:", error.message);
        
        return new Response(JSON.stringify({
          success: false,
          error: error.message
        }, null, 2), {
          status: 500,
          headers: { 
            "Content-Type": "application/json", 
            ...corsHeaders 
          }
        });
      }
    }
    
    if (url.pathname === "/test-cookies") {
      try {
        const requestId = "test-" + Math.random().toString(36).substring(2, 8);
        const testCookies = await getManualCookiesForRequest(requestId);
        
        return new Response(JSON.stringify({
          success: true,
          message: "Cookie testi tamamlandÄ±",
          cookieCount: testCookies.size
        }, null, 2), {
          headers: { 
            "Content-Type": "application/json", 
            ...corsHeaders 
          }
        });
      } catch (error) {
        return new Response(JSON.stringify({
          success: false,
          error: error.message
        }, null, 2), {
          status: 500,
          headers: { 
            "Content-Type": "application/json", 
            ...corsHeaders 
          }
        });
      }
    }
    
    if (url.pathname === "/stress-test") {
      try {
        const count = parseInt(url.searchParams.get("count")) || 3;
        console.log(`ğŸ§ª STRESS TEST: ${count} paralel kayÄ±t`);
        
        const promises = [];
        for (let i = 0; i < count; i++) {
          const email = getFormattedEmail();
          console.log(`âš¡ [${i + 1}/${count}] Paralel kayÄ±t baÅŸlatÄ±lÄ±yor: ${email}`);
          promises.push(processRegistration(email, true));
        }
        
        const results = await Promise.allSettled(promises);
        const successCount = results.filter(r => r.status === 'fulfilled' && r.value.success).length;
        
        return new Response(JSON.stringify({
          success: true,
          message: `Stress test tamamlandÄ±: ${successCount}/${count} baÅŸarÄ±lÄ±`,
          results: results.map(r => r.status === 'fulfilled' ? r.value : { success: false, error: r.reason })
        }, null, 2), {
          headers: { 
            "Content-Type": "application/json", 
            ...corsHeaders 
          }
        });
      } catch (error) {
        return new Response(JSON.stringify({
          success: false,
          error: error.message
        }, null, 2), {
          status: 500,
          headers: { 
            "Content-Type": "application/json", 
            ...corsHeaders 
          }
        });
      }
    }
    
    return new Response(JSON.stringify({
      message: "Hepsiburada KayÄ±t API - TAM Ã‡OKLU Ä°STEK DESTEÄÄ°",
      endpoints: {
        "/register": "Tek kayÄ±t baÅŸlat",
        "/stress-test?count=5": "Paralel stress test",
        "/test-cookies": "Cookie testi"
      }
    }, null, 2), {
      headers: { 
        "Content-Type": "application/json", 
        ...corsHeaders 
      }
    });
  }
};

export {
  worker_default as default
};
